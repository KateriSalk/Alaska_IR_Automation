---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(dplyr)
library(tibble)
library(knitr)
library(AKDECtools)
library(htmltools)
library(ggplot2)
library(ggspatial)
library(leaflet)
library(viridis)
library(ggpubr)
```

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open Sans">

```{css}
h1 {color:White; background-color:#253B64; text-align: center;}
h3 {color:#253B64; font-weight: bold;}
body {background-color: #F7F5F2; font-family: "Open Sans", Arial, sans-serif;}
```

[![](www/dec-logo-large.png){width="11%"}](https://dec.alaska.gov/water/water-quality/)

<br>

# Assessment Unit Summary

Assessment units are entire waterbodies or portions of them that fall within a specified hydrologic area such as a watershed. Using data obtained during a public call for data and pre-defined assessment methodologies, these units are analyzed to determine if the assessment unit is meeting Alaska water quality standards. After this analysis is completed, waterbodies are placed in corresponding categories (see definitions below).

```{r, results = 'asis'}
cat(paste0('This ', au_type, ' Assessment Unit is ', round(au_shape$Shape_4_Summary, 3), ' ', au_shape$AU_Shape_Unit, ' and is located in HUC', au_shape$HUC10_ID ,'.'))
```

::: {align="center"}
<br>

```{r}
output_df_au %>%
  mutate(AU_Name = au_shape$Name_AU) %>%
  select(
    `AU ID: ` = AUID_ATTNS,
    `AU Name: ` = AU_Name,
    `AU Type: ` = AU_Type) %>% 
  unique() %>%
  t() %>%
  kable() 
```

<br>

```{r, results = 'asis'}
# {r, fig.dim = c(5.5,4)}
#Map AU with monitoring sites
#center <- st_centroid(au_shape)$geometry

au_shape_4_map <- st_transform(au_shape, crs = 'EPSG:4326')
sites_4_map <- st_transform(sites, crs='EPSG:4326')


pal <- colorFactor(
  palette = viridis_pal(alpha = 1, begin = 0, end = 1,
                        option = 'mako')(nrow(sites)),
  domain = sites_4_map$MonitoringLocationIdentifier,
  ordered = TRUE)

leaflet() %>% 
  addTiles() %>%
  addProviderTiles(providers$Esri.NatGeoWorldMap) %>% 
  addPolylines(data = au_shape_4_map,
               color = '#072f95',
               opacity  = 1) %>%
  addCircleMarkers(data = sites_4_map,
                   radius = 3,
                   color = ~pal(MonitoringLocationIdentifier),
                   opacity  = 1,
                   label = sites_4_map$MonitoringLocationIdentifier,
                   labelOptions = labelOptions(noHide = F)) %>%
  addLegend("bottomright",
            pal = pal,
            values = sites_4_map$MonitoringLocationIdentifier,
            title = "Monitoring Location",
            opacity = 1) %>%
  addLegend('bottomright',
            color = '#072f95',
            label = au_shape_4_map$AUID_ATTNS,
            title = 'AU ID',
            opacity = 1)



# ggplot() +
#   annotation_map_tile("osm") +
#   geom_sf(data = au_shape, aes(color = AUID_ATTNS), linewidth = 1) +
#   geom_sf(data = sites, aes(fill = MonitoringLocationIdentifier),
#           shape = 21, color = 'black', size = 2.25) +
#   # xlim(x_lim) +
#   # ylim(y_lim) +
#   ggtitle('Assessment Unit with Monitoring Locations') +
#   theme_bw() +
#   viridis::scale_fill_viridis(name = 'Monitoring Location', discrete = T, option = "mako") + 
#   scale_color_manual(name = 'AU ID', values = c('#072f49')) + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5),
#         legend.position = 'top',
#         #plot.margin = margin(0.25,1,0.25,0.25, unit = 'in'),
#         plot.title.position = 'plot')

```

<br>

### Monitoring Location(s) Summary

```{r}
sites %>%
  st_drop_geometry() %>%
  select(
    `Monitoring Location` = MonitoringLocationIdentifier,
    Latitude,
    Longitude) %>% 
  unique() %>%
  kable() 
```

<br>

### Assessment Unit Location within Alaska

```{r}
# {r, fig.dim = c(4,3)}
#Maps
center <- st_centroid(st_make_valid(au_shape_4_map))

ggplot() +
  geom_sf(data = ak, fill = 'gray92', color = 'gray60') +
  geom_sf(data = center, color = '#435200', fill = '#435200', size = 5) +
  # ggtitle("Assessment Unit Location within Alaska") + 
  theme_bw()
  
```

\newpage

<br>

<br>

### Designated Uses and Attainment

```{r}

output_df_au %>%
  select(
    `Use: ` = Use,
    `Use Category: `= Use_Category) %>% 
  unique() %>%
  kable() 
```
:::

###### **Categories 1 and 2:** Waters for which there is enough information to determine that water quality standards are attained for all or some of their designated uses.

###### **Category 3:** Waters for which there is not enough information to determine their status.

###### **Category 4:** Waters that are impaired, but have one of several different types of waterbody recovery plans.

###### **Category 5:** Waters that are impaired and do not yet have waterbody recovery plans. Also known as 303(d) list impaired waters.

\newpage

<br>

<br>

::: {align="center"}
### Attainment by Parameter

```{r, echo = FALSE}
output_df_au %>%
  filter(!is.na(n_Samples)) %>%
  mutate(Attainment = case_when(Individual_Category == 3 ~
                                          'Insufficient data (3)',
                                        Individual_Category == 2 ~
                                          'Not exceeding (2)',
                                        Individual_Category == 5 ~
                                          'Exceeding (5)')) %>%
    select(
    Parameter = TADA.CharacteristicName,
    `Designated Use` = Use,
    Attainment,
    `# of Samples` = n_Samples,
    `# of Sample Dates` = n_SampDates) %>% 
  unique() %>%
  arrange(Parameter) %>%
  kable()
```
:::

###### **Parameter:** Qualitative or quantitative measurements of physical, chemical, or biological attributes such as temperatures, metals, or bacteria.

###### **Designated Use:** Water quality goals of a waterbody or portion thereof, in part, by designating the use or uses to be made of the water.

###### **Impairment:** Impairment means that a waterbody is persistently exceeding criteria for one or more pollutants and not supporting all designated uses.

###### **Attainment:** Achieving attainment means that a waterbody is supporting all designated uses for the pollutant parameters evaluated.

\newpage

<br>

<br>

::: {align="center"}
### Distribution of Parameters

```{r, echo=FALSE,results='hide',fig.keep='all', fig.dim= c(11,5)}
plots<- AKDECtools::boxPlot(data = output_samples, WQS_table = wqs_table,
                          AU_ID = au_loop, y_axis_log = T) 

ggarrange(plotlist = plots,
         ncol = 2,
         common.legend = T) 
```

\newpage

<br>

<br>

### Parameter Specific Time Series

```{r, echo=FALSE,results='hide',fig.keep='all', fig.dim= c(10,5)}
plots2 <- AKDECtools::timeSeries(data = output_samples, WQS_table = wqs_table,
                       AU_ID = au_loop, y_axis_log = T)

ggarrange(plotlist = plots2,
         ncol = 2,
        common.legend = T)
```
:::
